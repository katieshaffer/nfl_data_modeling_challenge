version: 2
models:
  - name: fct_fantasy_point_leaders
    description: >-
      Fact table ranking players by their fantasy performance using both
      standard and PPR scoring, aggregating across all weeks and handling team
      changes.
    columns:
      - name: player_id
        description: Unique identifier for the player.
        tests:
          - unique
          - not_null
        meta:
          dimension:
            type: string
      - name: player_name
        description: Name of the player.
        tests:
          - not_null
        meta:
          dimension:
            type: string
      - name: position
        description: Player's position (e.g., QB, RB, WR, TE).
        tests:
          - not_null
        meta:
          dimension:
            type: string
      - name: recent_team
        description: >-
          The player's most recent team, captured using LAST_VALUE based on
          season week.
        meta:
          dimension:
            type: string
      - name: total_fantasy_points_rounded
        description: Total fantasy points scored (standard scoring), rounded to 2 decimals
        meta:
          metrics:
            total_std_fantasy_points:
              type: sum
              description: Total standard fantasy points scored
            avg_std_fantasy_points:
              type: average
              description: Average standard fantasy points across all players
          dimension:
            type: number
      - name: total_fantasy_points_ppr_rounded
        description: Total PPR fantasy points scored, rounded to 2 decimals
        meta:
          metrics:
            total_ppr_fantasy_points:
              type: sum
              description: Total PPR fantasy points scored
            avg_ppr_fantasy_points:
              type: average
              description: Average PPR fantasy points across all players
          dimension:
            type: number
      - name: games_played
        description: Number of distinct games (weeks) the player participated in.
        meta:
          dimension:
            type: number
      - name: avg_fantasy_points_per_game
        description: Average standard fantasy points per game, rounded to 2 decimal places.
        meta:
          dimension:
            type: number
      - name: avg_fantasy_points_ppr_per_game
        description: Average PPR fantasy points per game, rounded to 2 decimal places.
        meta:
          dimension:
            type: number
      - name: standard_rank
        description: >-
          The player's rank among all players based on total standard fantasy
          points.
        meta:
          dimension:
            type: number
      - name: ppr_rank
        description: The player's rank among all players based on total PPR fantasy points.
        meta:
          dimension:
            type: number
      - name: standard_position_rank
        description: >-
          The player's rank within their position based on total standard
          fantasy points.
        meta:
          dimension:
            type: number
      - name: ppr_position_rank
        description: >-
          The player's rank within their position based on total PPR fantasy
          points.
        meta:
          dimension:
            type: number
      - name: total_fantasy_points
        description: ""
        meta:
          dimension:
            type: number
      - name: total_fantasy_points_ppr
        description: ""
        meta:
          dimension:
            type: number

  - name: fct_weekly_top_performers
    description: >-
      Weekly rankings of players by fantasy performance, both within position
      and overall
    columns:
      - name: player_id
        description: Unique identifier for the player
        tests:
          - not_null
        meta:
          dimension:
            type: string
      - name: player_name
        description: Name of the player
        tests:
          - not_null
        meta:
          dimension:
            type: string
      - name: position
        description: Player's position (QB, RB, WR, TE)
        tests:
          - not_null
        meta:
          dimension:
            type: string
      - name: recent_team
        description: Player's team for that week
        meta:
          dimension:
            type: string
      - name: season_week
        description: Week number in the season
        tests:
          - not_null
        meta:
          dimension:
            type: number
      - name: total_fantasy_points
        description: "Total fantasy points scored in standard scoring"
        meta:
          metrics:
            weekly_avg_fantasy_points:
              type: average
              description: "Average weekly fantasy points across all players"
            weekly_total_fantasy_points:
              type: sum
              description: "Total weekly fantasy points scored"
          dimension:
            type: number
      - name: total_fantasy_points_ppr
        description: "Total fantasy points scored in PPR scoring"
        meta:
          metrics:
            weekly_avg_fantasy_points_ppr:
              type: average
              description: "Average weekly PPR fantasy points across all players"
            weekly_total_fantasy_points_ppr:
              type: sum
              description: "Total weekly PPR fantasy points scored"
          dimension:
            type: number
      - name: position_rank_standard
        description: "Player's rank within their position for standard scoring"
        meta:
          metrics:
            avg_position_rank:
              type: average
              description: "Average position rank in standard scoring"
          dimension:
            type: number
      - name: position_rank_ppr
        description: Player's rank within their position for PPR scoring
        meta:
          dimension:
            type: number
      - name: overall_rank_standard
        description: Player's overall rank across all positions for standard scoring
        meta:
          dimension:
            type: number
      - name: overall_rank_ppr
        description: Player's overall rank across all positions for PPR scoring
        meta:
          dimension:
            type: number
      - name: position_leader_standard
        description: ""
        meta:
          dimension:
            type: boolean
      - name: position_leader_ppr
        description: ""
        meta:
          dimension:
            type: boolean

  - name: fct_defense_vs_position
    description: >-
      Analysis of how each team's defense performs against different positions
      in fantasy
    columns:
      - name: defense_team
        description: Team playing defense
        tests:
          - not_null
        meta:
          dimension:
            type: string
      - name: position
        description: Offensive position being analyzed
        tests:
          - not_null
        meta:
          dimension:
            type: string
      - name: players_faced
        description: Number of unique players faced at this position
        meta:
          dimension:
            type: number
      - name: games_played
        description: Number of games analyzed
        meta:
          dimension:
            type: number
      - name: avg_fantasy_points_allowed
        description: "Average fantasy points allowed to this position per game"
        meta:
          metrics:
            avg_defense_points_allowed:
              type: average
              description: "Average fantasy points allowed by defenses"
            worst_defense_points_allowed:
              type: max
              description: "Highest average points allowed by any defense"
            best_defense_points_allowed:
              type: min
              description: "Lowest average points allowed by any defense"
          dimension:
            type: number
      - name: avg_fantasy_points_ppr_allowed
        description: Average PPR fantasy points allowed to this position per game
        meta:
          dimension:
            type: number
      - name: total_fantasy_points_allowed
        description: "Total fantasy points allowed to this position"
        meta:
          metrics:
            total_points_allowed_all_defenses:
              type: sum
              description: "Total fantasy points allowed by all defenses"
          dimension:
            type: number
      - name: total_fantasy_points_ppr_allowed
        description: Total PPR fantasy points allowed to this position
        meta:
          dimension:
            type: number
      - name: position_defense_rank_standard
        description: >-
          Rank of defense against this position in standard scoring (1 = least
          points allowed)
        meta:
          dimension:
            type: number
      - name: position_defense_rank_ppr
        description: >-
          Rank of defense against this position in PPR scoring (1 = least points
          allowed)
        meta:
          dimension:
            type: number

  - name: fct_red_zone_player_stats
    description: Player-level analysis of red zone opportunities and efficiency
    columns:
      - name: fantasy_player_id
        description: Unique identifier for the player
        tests:
          - not_null
        meta:
          dimension:
            type: string
      - name: fantasy_player_name
        description: Name of the player
        tests:
          - not_null
        meta:
          dimension:
            type: string
      - name: total_opportunities
        description: "Total red zone opportunities (rush attempts + targets)"
        meta:
          metrics:
            total_red_zone_opportunities:
              type: sum
              description: "Total red zone opportunities across all players"
            avg_red_zone_opportunities:
              type: average
              description: "Average red zone opportunities per player"
          dimension:
            type: number
      - name: total_rush_attempts
        description: Number of rushing attempts in the red zone
        meta:
          dimension:
            type: number
      - name: total_targets
        description: Number of passing targets in the red zone
        meta:
          dimension:
            type: number
      - name: total_pass_completions
        description: Number of completed passes in the red zone
        meta:
          metrics:
            red_zone_completion_rate:
              type: number
              sql: >-
                SUM(total_pass_completions)::float / NULLIF(SUM(total_targets),
                0) * 100
              description: Red zone pass completion percentage
          dimension:
            type: number
      - name: total_touchdowns
        description: "Total touchdowns scored in red zone"
        meta:
          metrics:
            total_red_zone_tds:
              type: sum
              description: "Total red zone touchdowns scored"
            red_zone_td_rate:
              type: number
              sql: "SUM(total_touchdowns)::float / NULLIF(SUM(total_opportunities), 0) * 100"
              description: "Percentage of red zone opportunities resulting in touchdowns"
          dimension:
            type: number
      - name: completion_percentage
        description: ""
        meta:
          dimension:
            type: number
      - name: touchdown_rate
        description: ""
        meta:
          dimension:
            type: number

  - name: fct_team_red_zone_stats
    description: Team-level analysis of red zone performance and efficiency
    columns:
      - name: total_red_zone_plays
        description: Total number of plays run in the red zone
        meta:
          metrics:
            red_zone_efficiency:
              type: number
              sql: >-
                SUM(red_zone_touchdowns)::float /
                NULLIF(SUM(total_red_zone_plays), 0) * 100
              description: Percentage of red zone plays resulting in touchdowns
          dimension:
            type: number
      - name: red_zone_touchdowns
        description: Number of touchdowns scored in the red zone
        meta:
          metrics:
            total_red_zone_touchdowns:
              type: sum
              description: Total touchdowns scored in the red zone
            red_zone_touchdown_rate:
              type: number
              sql: >-
                SUM(red_zone_touchdowns)::float /
                NULLIF(SUM(total_red_zone_plays), 0) * 100
              description: Percentage of red zone plays resulting in touchdowns
          dimension:
            type: number
      - name: rush_attempts
        description: Number of rushing attempts in the red zone
        meta:
          dimension:
            type: number
      - name: pass_attempts
        description: Number of passing attempts in the red zone
        meta:
          dimension:
            type: number
      - name: rush_touchdowns
        description: "Number of rushing touchdowns in the red zone"
        meta:
          metrics:
            total_rush_touchdowns:
              type: sum
              description: "Total rushing touchdowns in red zone"
            rush_td_efficiency:
              type: number
              sql: "SUM(rush_touchdowns)::float / NULLIF(SUM(rush_attempts), 0) * 100"
              description: "Rushing touchdown percentage in red zone"
          dimension:
            type: number
      - name: pass_touchdowns
        description: "Number of passing touchdowns in the red zone"
        meta:
          metrics:
            total_pass_touchdowns:
              type: sum
              description: "Total passing touchdowns in red zone"
            pass_td_efficiency:
              type: number
              sql: "SUM(pass_touchdowns)::float / NULLIF(SUM(pass_attempts), 0) * 100"
              description: "Passing touchdown percentage in red zone"
          dimension:
            type: number
      - name: team
        description: ""
        meta:
          dimension:
            type: string
      - name: red_zone_touchdown_percentage
        description: ""
        meta:
          dimension:
            type: number
      - name: rush_touchdown_percentage
        description: ""
        meta:
          dimension:
            type: number
      - name: pass_touchdown_percentage
        description: ""
        meta:
          dimension:
            type: number
      - name: efficiency_rank
        description: ""
        meta:
          dimension:
            type: number